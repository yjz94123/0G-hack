generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== 事件表 ====================
model Event {
  id          String   @id                   // Polymarket event ID
  slug        String   @unique
  title       String
  description String?
  startDate   DateTime?
  endDate     DateTime?
  active      Boolean  @default(true)
  closed      Boolean  @default(false)
  liquidity   Float    @default(0)
  volume      Float    @default(0)
  image       String?
  icon        String?
  tags        String[] // Tag labels

  markets     Market[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([active, closed])
  @@index([updatedAt])
  @@map("events")
}

// ==================== 市场表 ====================
model Market {
  id            String   @id @default(cuid())
  conditionId   String   @unique            // Polymarket conditionId
  onChainId     String?                     // keccak256(conditionId), 链上 marketId
  question      String
  slug          String?
  endDate       DateTime?
  active        Boolean  @default(true)
  closed        Boolean  @default(false)
  outcomes      String[] // ["Yes", "No"]
  outcomePrices Float[]  // [0.65, 0.35]
  clobTokenIds  String[] // CLOB token IDs for Yes/No
  liquidity     Float    @default(0)
  volume        Float    @default(0)

  // 关联
  eventId       String
  event         Event    @relation(fields: [eventId], references: [id])

  priceHistory  PriceHistory[]
  analyses      AnalysisTask[]

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([active, closed])
  @@index([eventId])
  @@index([updatedAt])
  @@map("markets")
}

// ==================== 价格历史表 ====================
model PriceHistory {
  id          String   @id @default(cuid())
  marketId    String
  market      Market   @relation(fields: [marketId], references: [id])
  yesPrice    Float
  noPrice     Float
  volume24h   Float?
  timestamp   DateTime @default(now())

  @@index([marketId, timestamp])
  @@map("price_history")
}

// ==================== AI 分析任务表 ====================
model AnalysisTask {
  id          String   @id @default(cuid())
  taskId      String   @unique              // UUID
  marketId    String
  market      Market   @relation(fields: [marketId], references: [id])
  status      String   @default("pending")  // pending | processing | completed | failed
  result      Json?                         // AI 分析结果 JSON
  ogTxHash    String?                       // 0G Storage tx hash
  error       String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([marketId])
  @@index([status])
  @@map("analysis_tasks")
}

// ==================== 交易记录表 ====================
model TradeRecord {
  id            String   @id @default(cuid())
  userAddress   String                       // 用户钱包地址
  marketId      String                       // 关联市场
  orderId       String   @unique             // 链上 order ID
  side          String                       // buy | sell
  outcome       String                       // Yes | No
  amount        Float                        // 交易数量
  price         Float                        // 成交价格
  txHash        String?                      // 链上交易哈希
  ogKvKey       String?                      // 0G KV Storage key
  status        String   @default("pending") // pending | confirmed | failed

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([userAddress])
  @@index([marketId])
  @@index([status])
  @@map("trade_records")
}
